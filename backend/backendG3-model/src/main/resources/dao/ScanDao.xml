<?xml version="1.0" encoding="UTF-8"?>
<JdbcEntitySetup
        xmlns="http://www.ontimize.com/schema/jdbc"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.ontimize.com/schema/jdbc http://www.ontimize.com/schema/jdbc/ontimize-jdbc-dao.xsd"
        catalog="" schema="${mainschema}" table="scan"
        datasource="mainDataSource" sqlhandler="dbSQLStatementHandler">
    <DeleteKeys>
        <Column>id_scan_result</Column>
    </DeleteKeys>
    <UpdateKeys>
        <Column>id_scan_result</Column>
    </UpdateKeys>
    <GeneratedKey>id_scan_result</GeneratedKey>
    <Queries>
        <Query id="groupByDate">
            <Sentence>
                <![CDATA[
                WITH t_query AS (
                    WITH date_range AS (
                            SELECT
                                generate_series( (SELECT MIN(scan_date_in)
                            FROM scan),
                            (
                                SELECT MAX(scan_date_in)
                                FROM scan
                                ), '1 day' )::DATE AS generated_date
                            )
                    SELECT date_range.generated_date AS date, COALESCE(conteo, 0) AS conteo
                    FROM date_range
                    LEFT JOIN (
                        SELECT date(scan_date_in) AS fecha, COUNT(*) AS conteo
                        FROM scan sr
                        GROUP BY sr.id_dev_in, date(scan_date_in)
                    )
                    AS sr_count ON date_range.generated_date = sr_count.fecha
                    ORDER BY date_range.generated_date
                )
                SELECT #COLUMNS#
                FROM t_query
                #WHERE#
                ]]>
            </Sentence>
        </Query>
    </Queries>
</JdbcEntitySetup>